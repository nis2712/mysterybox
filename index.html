<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Surprise Box - Ramadhan Event</title>
<style>
  :root{
    /* Ramadhan Event (simple, festive, not too agamis) */
    --bg1:#063a2d;         /* deep emerald */
    --bg2:#0b5b46;         /* emerald */
    --accent:#f6c453;      /* gold */
    --accent2:#ffdd8a;     /* soft gold */
    --card:#ffffff;
    --shadow: 0 12px 26px rgba(0,0,0,.22);
    --pick: rgba(246,196,83,.95);
    --open:#fff3cf;
    --text:#1f2937;
    --btn:#f6c453;
    --btnText:#1b1b1b;
    --muted: rgba(255,255,255,.75);
    --muted2: rgba(255,255,255,.55);
  }

  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background:
      radial-gradient(1200px 600px at 20% 10%, rgba(246,196,83,.18), transparent 60%),
      radial-gradient(900px 500px at 85% 25%, rgba(255,221,138,.14), transparent 55%),
      linear-gradient(135deg,var(--bg1),var(--bg2));
    text-align:center;
    overflow:hidden;
    color:#fff;
  }

  /* subtle ornaments */
  .ornaments{
    position:fixed;
    inset:0;
    pointer-events:none;
    opacity:.55;
    z-index:0;
  }
  .ornaments::before{
    content:"";
    position:absolute;
    inset:-40px;
    background-image:
      radial-gradient(circle at 20% 30%, rgba(255,255,255,.10) 0 2px, transparent 3px),
      radial-gradient(circle at 80% 20%, rgba(255,255,255,.10) 0 2px, transparent 3px),
      radial-gradient(circle at 35% 70%, rgba(255,255,255,.08) 0 2px, transparent 3px),
      radial-gradient(circle at 70% 75%, rgba(255,255,255,.08) 0 2px, transparent 3px);
    background-size: 260px 260px;
    filter: blur(.2px);
  }
  .ornaments::after{
    content:"";
    position:absolute;
    left:-20%;
    top:-30%;
    width:140%;
    height:140%;
    background:
      repeating-linear-gradient(45deg, rgba(246,196,83,.08), rgba(246,196,83,.08) 2px, transparent 2px, transparent 18px);
    transform: rotate(6deg);
    opacity:.35;
    mask-image: radial-gradient(circle at 50% 45%, rgba(0,0,0,1), transparent 70%);
  }

  /* main wrapper to sit above ornaments */
  #overlayUI, #adminUI{ position:relative; z-index:1; }

  h1{
    margin:16px 0 6px;
    font-weight:1000;
    letter-spacing:.6px;
    text-transform:uppercase;
    font-size: clamp(20px, 3.5vw, 34px);
    color:#fff;
    text-shadow: 0 8px 18px rgba(0,0,0,.35);
  }
  .note{
    color:var(--muted);
    font-weight:900;
    text-shadow:0 6px 14px rgba(0,0,0,.25);
    margin-bottom:10px;
  }

  .topbar{
    display:flex;
    justify-content:center;
    gap:10px;
    flex-wrap:wrap;
    padding:8px 12px 14px;
  }

  .mode-btn, .ctrl-btn{
    padding:10px 16px;
    border:none;
    border-radius:16px;
    font-size:14px;
    font-weight:1000;
    cursor:pointer;
    box-shadow:0 10px 18px rgba(0,0,0,.20);
    transition:transform .15s ease, filter .15s ease, box-shadow .15s ease;
  }
  .mode-btn:hover, .ctrl-btn:hover{
    transform:translateY(-1px) scale(1.02);
    filter:brightness(1.03);
    box-shadow:0 14px 22px rgba(0,0,0,.24);
  }
  .mode-btn.active{
    outline:3px solid rgba(246,196,83,.75);
  }

  /* mode buttons (harmonized) */
  .hemat{ background: rgba(255,255,255,.10); color:#fff; border:1px solid rgba(255,255,255,.18); }
  .royal{ background: rgba(246,196,83,.22); color:#fff; border:1px solid rgba(246,196,83,.35); }
  .tajir{ background: rgba(255,221,138,.18); color:#fff; border:1px solid rgba(255,221,138,.28); }

  .ctrl-btn{
    background: var(--btn);
    color: var(--btnText);
    border:1px solid rgba(0,0,0,.12);
  }
  .ctrl-btn:disabled{
    opacity:.55; cursor:not-allowed; transform:none; filter:none; box-shadow:none;
  }

  .grid{
    display:grid;
    grid-template-columns:repeat(5,110px);
    gap:14px;
    justify-content:center;
    padding:10px 12px 26px;
    position:relative;
  }

  .box{
    background: rgba(255,255,255,.94);
    border-radius:22px;
    padding:14px 10px;
    cursor:pointer;
    box-shadow:var(--shadow);
    transition:transform .16s ease, filter .16s ease;
    position:relative;
    min-height:96px;
    display:flex;
    flex-direction:column;
    justify-content:flex-start;
    align-items:center;
    transform: translateZ(0);
    border:1px solid rgba(0,0,0,.06);
    overflow:hidden;
  }
  /* small festive corner */
  .box::before{
    content:"";
    position:absolute;
    right:-26px; top:-26px;
    width:72px; height:72px;
    background: radial-gradient(circle at 35% 35%, rgba(246,196,83,.65), rgba(246,196,83,.05) 60%, transparent 70%);
    transform: rotate(25deg);
    opacity:.8;
    pointer-events:none;
  }
  .box:hover{ transform:translateY(-2px) scale(1.02); filter:brightness(1.02); }
  .box.disabled{ cursor:not-allowed; }
  .box.disabled:hover{ transform:none; filter:none; }

  .num{
    font-size:18px;
    font-weight:1000;
    color:var(--text);
    line-height:1;
    opacity:.9;
  }

  .gift{
    margin-top:10px;
    display:none;
    width:100%;
  }
  .giftImg{
    width:64px;
    height:64px;
    object-fit:contain;
    filter: drop-shadow(0 8px 12px rgba(0,0,0,.18));
    opacity:0;
    transform: translateY(6px) scale(.98);
  }
  .giftName{
    margin-top:6px;
    font-size:12px;
    font-weight:1000;
    color:var(--text);
    opacity:0;
    transform: translateY(6px);
  }

  .box.revealed{
    background:var(--open);
    border-color: rgba(246,196,83,.35);
  }
  .box.revealed .gift{ display:block; }

  .box.revealed .giftImg,
  .box.revealed .giftName{
    animation: revealPop .45s cubic-bezier(.2,.85,.2,1) forwards;
    animation-delay: var(--d);
    will-change: transform, opacity;
  }
  @keyframes revealPop{
    to{ opacity:1; transform: translateY(0) scale(1); }
  }

  .box.picked{
    outline:4px solid rgba(246,196,83,.85);
    box-shadow: 0 12px 26px rgba(0,0,0,.24), 0 0 0 7px rgba(246,196,83,.18);
  }
  .tag{
    position:absolute;
    top:10px; right:10px;
    background:var(--pick);
    color:#1b1b1b;
    font-weight:1000;
    font-size:11px;
    padding:4px 8px;
    border-radius:999px;
    display:none;
  }
  .box.picked .tag{ display:block; }

  /* POPUP */
  .popup{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.50);
    display:none;
    justify-content:center;
    align-items:center;
    padding:16px;
    z-index:50;
  }
  .popup-content{
    background:rgba(255,255,255,.98);
    padding:22px 18px;
    border-radius:26px;
    max-width:520px;
    width:100%;
    box-shadow:0 22px 46px rgba(0,0,0,.40);
    animation: pop .35s ease;
    border:1px solid rgba(0,0,0,.06);
  }
  @keyframes pop{
    0%{ transform:scale(0.7); opacity:0; }
    100%{ transform:scale(1); opacity:1; }
  }
  .popup h2{
    margin:0 0 10px;
    color:#0b5b46;
    font-size:26px;
    font-weight:1000;
  }
  .popupPrizeImg{
    width:150px;height:150px;object-fit:contain;
    border-radius:20px;
    box-shadow:0 10px 22px rgba(0,0,0,.18);
    background:#fff;
    border:1px solid rgba(0,0,0,.06);
  }
  .popupPrizeName{
    margin:12px 0 0;
    font-size:20px;
    font-weight:1000;
    color:var(--text);
  }
  .close-btn{
    margin-top:16px;
    padding:10px 18px;
    border:none;
    border-radius:16px;
    font-size:15px;
    font-weight:1000;
    cursor:pointer;
    background: var(--btn);
    color: var(--btnText);
    box-shadow:0 10px 18px rgba(0,0,0,.18);
  }

  /* ADMIN */
  .adminWrap{
    width:min(980px, 96vw);
    margin:14px auto 28px;
    text-align:left;
    background:rgba(255,255,255,.92);
    border-radius:18px;
    padding:14px;
    box-shadow:var(--shadow);
    border:1px solid rgba(255,255,255,.12);
  }
  .adminHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .adminHeader h2{ margin:0; color:#0b5b46; font-weight:1000; }
  .adminHeader .small{ font-size:12px; font-weight:900; color:#111; opacity:.75; }
  .adminBtns{ display:flex; gap:8px; flex-wrap:wrap; }
  .aBtn{
    border:none;
    border-radius:14px;
    padding:10px 12px;
    font-weight:1000;
    cursor:pointer;
    background:#111;
    color:#fff;
  }
  .aBtn.alt{ background:#0b5b46; }
  .aBtn.good{ background:#22c55e; }
  .aBtn.warn{ background:#ef4444; }

  .tabs{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
  .tab{
    padding:10px 12px;
    border-radius:14px;
    border:2px solid rgba(0,0,0,.10);
    cursor:pointer;
    font-weight:1000;
    background:#fff;
    color:#0b5b46;
  }
  .tab.active{
    border-color: rgba(246,196,83,.75);
    box-shadow:0 8px 16px rgba(0,0,0,.10);
  }

  .rows{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }

  .row{
    display:grid;
    grid-template-columns: 110px 1fr 320px;
    gap:10px;
    align-items:center;
    padding:10px;
    border-radius:16px;
    background:#fff;
    border:2px solid rgba(0,0,0,.06);
  }

  .thumb{
    width:110px;height:70px;
    border-radius:14px;
    background:rgba(0,0,0,.04);
    display:flex;align-items:center;justify-content:center;
    overflow:hidden;
    border:1px solid rgba(0,0,0,.06);
  }
  .thumb img{ width:100%;height:100%;object-fit:contain; }

  .in{
    width:100%;
    padding:10px 12px;
    border-radius:14px;
    border:2px solid rgba(0,0,0,.10);
    font-weight:900;
  }
  .mini{ font-size:12px; font-weight:900; opacity:.75; margin-top:6px; }

  .rightPack{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:flex-end;
    flex-wrap:wrap;
  }
  .countWrap{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:4px;
    min-width:120px;
  }
  .countLabel{ font-size:12px; font-weight:1000; opacity:.85; }
  .countHint{ font-size:12px; font-weight:1000; opacity:.75; }
  .count{
    width:120px;
    padding:10px 12px;
    border-radius:14px;
    border:2px solid rgba(0,0,0,.10);
    font-weight:1000;
    text-align:center;
  }

  .del{
    border:none;
    border-radius:14px;
    padding:10px 12px;
    cursor:pointer;
    font-weight:1000;
    background:#ef4444;
    color:#fff;
  }
  .help{
    margin-top:10px;
    font-size:12px;
    font-weight:900;
    color:#111;
    opacity:.82;
    line-height:1.45;
  }

  /* SHUFFLE (keep your no-spoiler gimmick) */
  .shuffling .box{
    animation: shuffleShake .42s ease-in-out infinite;
    filter: blur(.2px) brightness(1.02);
  }
  @keyframes shuffleShake{
    0%{ transform:translate(0,0) rotate(0deg); }
    25%{ transform:translate(-3px,2px) rotate(-1.8deg); }
    50%{ transform:translate(3px,-2px) rotate(1.8deg); }
    75%{ transform:translate(-2px,-2px) rotate(-1deg); }
    100%{ transform:translate(0,0) rotate(0deg); }
  }

  .shuffleOverlay{
    position:absolute;
    inset:0;
    background:rgba(255,255,255,.78);
    display:flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    font-size:28px;
    font-weight:1000;
    color:#0b5b46;
    backdrop-filter: blur(6px);
    z-index:10;
    border-radius:18px;
    border:1px solid rgba(0,0,0,.06);
  }
  .dots{ display:inline-flex; gap:6px; align-items:center; }
  .dot{
    width:10px;height:10px;border-radius:999px;
    background:#0b5b46;
    opacity:.25;
    animation: dotPulse 1s infinite;
  }
  .dot:nth-child(2){ animation-delay:.15s; }
  .dot:nth-child(3){ animation-delay:.3s; }
  @keyframes dotPulse{
    0%,100%{ opacity:.25; transform:translateY(0); }
    50%{ opacity:.9; transform:translateY(-4px); }
  }

  /* responsive */
  @media (max-width: 640px){
    .grid{ grid-template-columns:repeat(3,110px); }
    .row{ grid-template-columns: 90px 1fr; }
    .rightPack{ justify-content:flex-start; }
  }
</style>
</head>
<body>

<div class="ornaments"></div>

<!-- OVERLAY UI -->
<div id="overlayUI">
  <h1>SURPRISE BOX RAMADHAN EVENT</h1>
  <div class="note" id="modeNote">Mode: HEMAT (1R)</div>

  <div class="topbar">
    <button class="mode-btn hemat active" data-mode="hemat">HEMAT</button>
    <button class="mode-btn royal" data-mode="royal">ROYAL</button>
    <button class="mode-btn tajir" data-mode="tajir">TAJIR</button>

    <button class="ctrl-btn" id="resetBtn">Reset</button>
    <button class="ctrl-btn" id="shuffleBtn">Shuffle</button>
  </div>

  <div class="grid" id="grid"></div>
</div>

<!-- POPUP -->
<div class="popup" id="popup">
  <div class="popup-content">
    <h2>Hadiah Kamu</h2>
    <img id="popupImg" class="popupPrizeImg" alt="">
    <div id="popupName" class="popupPrizeName"></div>
    <button class="close-btn" onclick="closePopup()">OK</button>
  </div>
</div>

<!-- ADMIN UI -->
<div id="adminUI" style="display:none;">
  <div class="adminWrap">
    <div class="adminHeader">
      <div>
        <h2>Admin Hadiah (Gambar + Rarity)</h2>
        <div class="small">Tersimpan di browser PC kamu (LocalStorage).</div>
      </div>
      <div class="adminBtns">
        <button class="aBtn alt" id="addItemBtn">+ Tambah Hadiah</button>
        <button class="aBtn good" id="saveBtn">Save</button>
        <button class="aBtn" id="exportBtn">Export</button>
        <button class="aBtn" id="importBtn">Import</button>
        <button class="aBtn warn" id="resetDefaultBtn">Reset Default</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-mode="hemat">HEMAT</div>
      <div class="tab" data-mode="royal">ROYAL</div>
      <div class="tab" data-mode="tajir">TAJIR</div>
    </div>

    <div class="help">
      ‚Ä¢ Set <b>Jumlah (rarity)</b> = berapa kotak yang berisi hadiah ini. Total tiap mode harus = <b>15</b>.<br>
      ‚Ä¢ Upload gambar (PNG/JPG/WebP). Disarankan ukuran kecil (misal 256√ó256, &lt; 200KB) biar lancar di Live Studio.<br>
      ‚Ä¢ Klik <b>Save</b>, lalu buka overlay normal (tanpa <b>?admin=1</b>).
    </div>

    <div class="rows" id="rows"></div>
  </div>
</div>

<script>
  // ==========================
  // 1) DEFAULT (kalau belum ada setting admin)
  // ==========================
  const DEFAULT_CONFIG = {
    hemat: [
      { name:"Coin 50", count:5, img:null },
      { name:"Candy", count:5, img:null },
      { name:"Sticker", count:4, img:null },
      { name:"Bonus", count:1, img:null }
    ],
    royal: [
      { name:"Coin 300", count:6, img:null },
      { name:"Gem 10", count:5, img:null },
      { name:"Royal Pack", count:3, img:null },
      { name:"Lucky Spin", count:1, img:null }
    ],
    tajir: [
      { name:"Coin 1000", count:7, img:null },
      { name:"Gem 30", count:5, img:null },
      { name:"Mega Box", count:2, img:null },
      { name:"SECRET", count:1, img:null }
    ]
  };

  const PRICE = { hemat:"1R", royal:"5R", tajir:"10R" };
  const STORAGE_KEY = "fun_box_config_v2";

  function loadConfig(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return structuredClone(DEFAULT_CONFIG);
      return JSON.parse(raw);
    }catch(e){
      return structuredClone(DEFAULT_CONFIG);
    }
  }
  function saveConfig(cfg){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(cfg));
  }

  let CONFIG = loadConfig();

  // ==========================
  // 2) OVERLAY LOGIC (smooth reveal)
  // ==========================
  const grid = document.getElementById("grid");
  const popup = document.getElementById("popup");
  const popupImg = document.getElementById("popupImg");
  const popupName = document.getElementById("popupName");
  const modeNote = document.getElementById("modeNote");

  const modeBtns = document.querySelectorAll(".mode-btn");
  const resetBtn = document.getElementById("resetBtn");
  const shuffleBtn = document.getElementById("shuffleBtn");

  let mode = "hemat";
  let slots = [];
  let pickedIndex = null;
  let isRevealing = false;
  let isShuffling = false;

  const STAGGER_MS = 80;
  const POPUP_DELAY_MS = 260;
  const SHUFFLE_ANIM_MS = 1200;

  function fisherYatesShuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }

  function buildSlotsFromConfig(modeKey){
    const items = CONFIG[modeKey] || [];
    const expanded = [];
    for(const it of items){
      const c = Math.max(0, parseInt(it.count || 0, 10));
      for(let k=0;k<c;k++){
        expanded.push({ name: it.name || "Hadiah", img: it.img || null });
      }
    }
    while(expanded.length < 15) expanded.push({ name:"?", img:null });
    while(expanded.length > 15) expanded.pop();
    return fisherYatesShuffle(expanded);
  }

  function resetRound(){
    pickedIndex = null;
    isRevealing = false;
    isShuffling = false;
    enableControls(true);
    slots = buildSlotsFromConfig(mode);
    render(false);
  }

  function shuffleOnly(){
    if(isRevealing || pickedIndex !== null || isShuffling) return;

    isShuffling = true;
    enableControls(false);

    const overlay = document.createElement("div");
    overlay.className = "shuffleOverlay";
    overlay.innerHTML = `SHUFFLING <span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
    grid.appendChild(overlay);

    grid.classList.add("shuffling");
    render(false);

    setTimeout(() => {
      slots = fisherYatesShuffle(slots);
      grid.classList.remove("shuffling");
      overlay.remove();
      render(false);
      enableControls(true);
      isShuffling = false;
    }, SHUFFLE_ANIM_MS);
  }

  function setMode(newMode){
    if(isShuffling) return;
    mode = newMode;
    modeBtns.forEach(b => b.classList.toggle("active", b.dataset.mode === newMode));
    modeNote.textContent = `Mode: ${newMode.toUpperCase()} (${PRICE[newMode]})`;
    resetRound();
  }

  function pick(i){
    if(pickedIndex !== null || isRevealing || isShuffling) return;
    pickedIndex = i;
    isRevealing = true;
    enableControls(false);

    render(true);

    const totalTime = (15 * STAGGER_MS) + 520;
    setTimeout(() => {
      const prize = slots[pickedIndex];
      popupImg.src = prize.img || makeEmojiDataUrl("üéÅ");
      popupName.textContent = prize.name || "Hadiah!";
      popup.style.display = "flex";
      enableControls(true);
    }, totalTime + POPUP_DELAY_MS);
  }

  function render(reveal){
    grid.innerHTML = "";
    for(let i=0;i<15;i++){
      const div = document.createElement("div");
      div.className = "box";
      if(isRevealing || isShuffling) div.classList.add("disabled");
      if(reveal) div.classList.add("revealed");
      if(pickedIndex === i) div.classList.add("picked");

      div.style.setProperty("--d", (i * STAGGER_MS) + "ms");

      const prize = slots[i];
      const imgSrc = prize?.img || makeEmojiDataUrl("üéÅ");

      div.innerHTML = `
        <div class="tag">PICK</div>
        <div class="num">${i+1}</div>
        <div class="gift">
          <img class="giftImg" src="${escapeAttr(imgSrc)}" alt="">
          <div class="giftName">${escapeHtml(prize?.name || "Hadiah")}</div>
        </div>
      `;
      div.onclick = () => pick(i);
      grid.appendChild(div);
    }
  }

  function enableControls(enabled){
    resetBtn.disabled = !enabled;
    shuffleBtn.disabled = !enabled;
    modeBtns.forEach(b => b.disabled = !enabled);
  }

  function closePopup(){
    popup.style.display = "none";
  }
  popup.addEventListener("click", (e) => {
    if(e.target === popup) closePopup();
  });

  function makeEmojiDataUrl(emoji){
    const svg =
      `<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
        <rect width="100%" height="100%" rx="44" ry="44" fill="white"/>
        <circle cx="210" cy="46" r="18" fill="#f6c453" opacity=".65"/>
        <text x="50%" y="58%" font-size="140" text-anchor="middle" dominant-baseline="middle">${emoji}</text>
      </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  function escapeHtml(str){
    return String(str)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&lt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function escapeAttr(str){
    return String(str).replaceAll('"',"&quot;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  // ==========================
  // 3) ADMIN UI (rarity + upload)
  // ==========================
  const isAdmin = new URLSearchParams(location.search).get("admin") === "1";
  const overlayUI = document.getElementById("overlayUI");
  const adminUI = document.getElementById("adminUI");
  const rowsEl = document.getElementById("rows");
  const tabEls = document.querySelectorAll(".tab");

  const addItemBtn = document.getElementById("addItemBtn");
  const saveBtn = document.getElementById("saveBtn");
  const exportBtn = document.getElementById("exportBtn");
  const importBtn = document.getElementById("importBtn");
  const resetDefaultBtn = document.getElementById("resetDefaultBtn");

  let adminMode = "hemat";

  function adminRender(){
    rowsEl.innerHTML = "";
    const items = CONFIG[adminMode] || [];

    items.forEach((it, idx) => {
      const row = document.createElement("div");
      row.className = "row";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      const img = document.createElement("img");
      img.src = it.img || makeEmojiDataUrl("üéÅ");
      thumb.appendChild(img);

      const nameWrap = document.createElement("div");
      const nameInput = document.createElement("input");
      nameInput.className = "in";
      nameInput.placeholder = "Nama hadiah (contoh: Coin 50)";
      nameInput.value = it.name || "";
      const mini = document.createElement("div");
      mini.className = "mini";
      mini.textContent = "Upload gambar atau biarkan default üéÅ";
      nameWrap.appendChild(nameInput);
      nameWrap.appendChild(mini);

      const file = document.createElement("input");
      file.type = "file";
      file.accept = "image/*";
      file.style.width = "140px";

      const del = document.createElement("button");
      del.className = "del";
      del.textContent = "Hapus";

      const countInput = document.createElement("input");
      countInput.className = "count";
      countInput.type = "number";
      countInput.min = "0";
      countInput.max = "15";
      countInput.step = "1";
      countInput.value = String(it.count ?? 0);

      const countWrap = document.createElement("div");
      countWrap.className = "countWrap";

      const countLabel = document.createElement("div");
      countLabel.className = "countLabel";
      countLabel.textContent = "Jumlah (rarity)";

      const countHint = document.createElement("div");
      countHint.className = "countHint";
      const pct0 = Math.round(((parseInt(countInput.value||"0",10)) / 15) * 100);
      countHint.textContent = `${countInput.value}/15 ‚âà ${pct0}%`;

      countWrap.appendChild(countLabel);
      countWrap.appendChild(countInput);
      countWrap.appendChild(countHint);

      const rightPack = document.createElement("div");
      rightPack.className = "rightPack";
      rightPack.appendChild(countWrap);
      rightPack.appendChild(file);
      rightPack.appendChild(del);

      nameInput.addEventListener("input", () => {
        CONFIG[adminMode][idx].name = nameInput.value;
      });

      countInput.addEventListener("input", () => {
        CONFIG[adminMode][idx].count = parseInt(countInput.value || "0", 10);
        const pct = Math.round(((parseInt(countInput.value||"0",10)) / 15) * 100);
        countHint.textContent = `${countInput.value}/15 ‚âà ${pct}%`;
      });

      file.addEventListener("change", async () => {
        const f = file.files?.[0];
        if(!f) return;
        const dataUrl = await fileToDataUrl(f);
        CONFIG[adminMode][idx].img = dataUrl;
        img.src = dataUrl;
      });

      del.addEventListener("click", () => {
        CONFIG[adminMode].splice(idx, 1);
        adminRender();
      });

      row.appendChild(thumb);
      row.appendChild(nameWrap);
      row.appendChild(rightPack);
      rowsEl.appendChild(row);
    });

    const total = (CONFIG[adminMode] || []).reduce((s,it)=>s + (parseInt(it.count||0,10)||0), 0);
    const info = document.createElement("div");
    info.className = "help";
    info.innerHTML = `Total kotak untuk mode <b>${adminMode.toUpperCase()}</b>: <b>${total}</b> (harus <b>15</b>).`;
    rowsEl.appendChild(info);
  }

  function fileToDataUrl(file){
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(String(r.result));
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  function adminSetMode(m){
    adminMode = m;
    tabEls.forEach(t => t.classList.toggle("active", t.dataset.mode === m));
    adminRender();
  }

  function validateAll(){
    const modes = ["hemat","royal","tajir"];
    const errs = [];
    for(const m of modes){
      const total = (CONFIG[m]||[]).reduce((s,it)=>s + (parseInt(it.count||0,10)||0), 0);
      if(total !== 15) errs.push(`${m.toUpperCase()} total ${total} (harus 15)`);
    }
    return errs;
  }

  addItemBtn?.addEventListener("click", () => {
    CONFIG[adminMode] = CONFIG[adminMode] || [];
    CONFIG[adminMode].push({ name:"Hadiah Baru", count:1, img:null });
    adminRender();
  });

  saveBtn?.addEventListener("click", () => {
    const errs = validateAll();
    if(errs.length){
      alert("Belum bisa Save. Perbaiki dulu:\n- " + errs.join("\n- "));
      return;
    }
    saveConfig(CONFIG);
    alert("Saved! Sekarang buka overlay normal (hapus ?admin=1).");
  });

  exportBtn?.addEventListener("click", () => {
    const data = JSON.stringify(CONFIG);
    navigator.clipboard.writeText(data).then(()=>{
      alert("Export berhasil: config dicopy ke clipboard.\nSimpan di Notes/WA sebagai backup.");
    }).catch(()=>{
      alert("Gagal copy otomatis. Coba browser lain atau copy manual.");
    });
  });

  importBtn?.addEventListener("click", () => {
    const raw = prompt("Paste config JSON hasil Export di sini:");
    if(!raw) return;
    try{
      const cfg = JSON.parse(raw);
      CONFIG = cfg;
      saveConfig(CONFIG);
      adminRender();
      alert("Import OK!");
    }catch(e){
      alert("JSON tidak valid.");
    }
  });

  resetDefaultBtn?.addEventListener("click", () => {
    if(!confirm("Reset ke default? Ini menghapus setting yang sekarang di browser.")) return;
    CONFIG = structuredClone(DEFAULT_CONFIG);
    saveConfig(CONFIG);
    adminRender();
  });

  tabEls.forEach(t => t.addEventListener("click", () => adminSetMode(t.dataset.mode)));

  // ==========================
  // 4) BOOT
  // ==========================
  if(isAdmin){
    overlayUI.style.display = "none";
    adminUI.style.display = "block";
    adminRender();
  }else{
    overlayUI.style.display = "block";
    adminUI.style.display = "none";

    modeBtns.forEach(btn => btn.addEventListener("click", () => setMode(btn.dataset.mode)));
    resetBtn.addEventListener("click", resetRound);
    shuffleBtn.addEventListener("click", shuffleOnly);

    resetRound();
  }
</script>
</body>
</html>
